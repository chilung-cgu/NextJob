# ðŸ”” ä¸­æ–·è™•ç†ï¼ˆInterruptï¼‰è©³è§£

> ä¸­æ–·æ˜¯åµŒå…¥å¼ç³»çµ±çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¹¾ä¹Žæ¯å ´éŸŒé«”é¢è©¦éƒ½æœƒå•ï¼

---

## ðŸ“Œ ä»€éº¼æ˜¯ä¸­æ–·ï¼Ÿ

```
ä¸­æ–·æ˜¯ä¸€ç¨®æ©Ÿåˆ¶ï¼Œè®“ç¡¬é«”æˆ–è»Ÿé«”å¯ä»¥ã€Œæ‰“æ–·ã€CPU æ­£åœ¨åŸ·è¡Œçš„ç¨‹å¼ï¼Œ
åŽ»è™•ç†æ›´ç·Šæ€¥çš„äº‹ä»¶ï¼Œè™•ç†å®Œå¾Œå†å›žåˆ°åŽŸæœ¬çš„ç¨‹å¼ç¹¼çºŒåŸ·è¡Œã€‚

é¡žæ¯”ï¼š
ä½ æ­£åœ¨å¯«ç¨‹å¼ï¼ˆä¸»ç¨‹å¼ï¼‰ï¼Œé›»è©±éŸ¿äº†ï¼ˆä¸­æ–·ç™¼ç”Ÿï¼‰ï¼Œ
ä½ æŽ¥èµ·é›»è©±è™•ç†ï¼ˆä¸­æ–·æœå‹™ç¨‹å¼ ISRï¼‰ï¼Œ
æŽ›æŽ‰é›»è©±å¾Œå›žä¾†ç¹¼çºŒå¯«ç¨‹å¼ï¼ˆè¿”å›žä¸»ç¨‹å¼ï¼‰ã€‚
```

---

## ðŸ”· ä¸­æ–·çš„é¡žåž‹

### 1. ç¡¬é«”ä¸­æ–·ï¼ˆExternal/Hardware Interruptï¼‰

```
ä¾†æºï¼šå¤–éƒ¨ç¡¬é«”äº‹ä»¶
ç¯„ä¾‹ï¼š
- GPIO pin ç‹€æ…‹æ”¹è®Š
- Timer è¨ˆæ™‚åˆ°é”
- UART æ”¶åˆ°è³‡æ–™
- ADC è½‰æ›å®Œæˆ
- I2C/SPI å‚³è¼¸å®Œæˆ
```

### 2. è»Ÿé«”ä¸­æ–·ï¼ˆSoftware Interruptï¼‰

```
ä¾†æºï¼šç¨‹å¼æŒ‡ä»¤è§¸ç™¼
ç¯„ä¾‹ï¼š
- ç³»çµ±å‘¼å«ï¼ˆSystem Callï¼‰
- SVC (Supervisor Call) æŒ‡ä»¤
- ä¾‹å¤–è™•ç†
```

### 3. ä¾‹å¤–ï¼ˆExceptionï¼‰

```
ä¾†æºï¼šCPU åŸ·è¡ŒéŽç¨‹ä¸­çš„ç•°å¸¸æƒ…æ³
ç¯„ä¾‹ï¼š
- é™¤ä»¥é›¶
- éžæ³•è¨˜æ†¶é«”å­˜å–
- æœªå®šç¾©æŒ‡ä»¤
- Hard Faultï¼ˆåœ¨ ARM Cortex-M ä¸­ï¼‰
```

---

## ðŸ”· ä¸­æ–·è™•ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸­æ–·è™•ç†å®Œæ•´æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. ä¸­æ–·ç™¼ç”Ÿ                                                 â”‚
â”‚     â†“                                                       â”‚
â”‚  2. CPU å®Œæˆç•¶å‰æŒ‡ä»¤                                         â”‚
â”‚     â†“                                                       â”‚
â”‚  3. ä¿å­˜ Contextï¼ˆç¨‹å¼è¨ˆæ•¸å™¨ PCã€æš«å­˜å™¨ã€ç‹€æ…‹ç­‰ï¼‰             â”‚
â”‚     â†“                                                       â”‚
â”‚  4. æŸ¥è©¢ä¸­æ–·å‘é‡è¡¨ï¼ˆInterrupt Vector Tableï¼‰                  â”‚
â”‚     â†“                                                       â”‚
â”‚  5. è·³è½‰åˆ°å°æ‡‰çš„ ISRï¼ˆInterrupt Service Routineï¼‰            â”‚
â”‚     â†“                                                       â”‚
â”‚  6. åŸ·è¡Œ ISR                                                 â”‚
â”‚     â†“                                                       â”‚
â”‚  7. æ¢å¾© Context                                             â”‚
â”‚     â†“                                                       â”‚
â”‚  8. å›žåˆ°åŽŸç¨‹å¼ç¹¼çºŒåŸ·è¡Œ                                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”· ä¸­æ–·å‘é‡è¡¨ï¼ˆInterrupt Vector Tableï¼‰

```c
// ä¸­æ–·å‘é‡è¡¨æ˜¯ä¸€å€‹é™£åˆ—ï¼Œå„²å­˜æ¯å€‹ä¸­æ–·å°æ‡‰çš„ ISR ä½å€
// é€šå¸¸æ”¾åœ¨è¨˜æ†¶é«”æœ€ä½Žä½å€ï¼ˆä¾‹å¦‚ 0x00000000ï¼‰

// ARM Cortex-M ç¯„ä¾‹
__attribute__((section(".isr_vector")))
const void (*vector_table[])(void) = {
    (void *)&_estack,           // 0x00: Initial Stack Pointer
    Reset_Handler,              // 0x04: Reset Handler
    NMI_Handler,                // 0x08: NMI
    HardFault_Handler,          // 0x0C: Hard Fault
    // ... å…¶ä»–ç³»çµ±ä¾‹å¤– ...
    SysTick_Handler,            // 0x3C: SysTick
    // å¤–éƒ¨ä¸­æ–·
    EXTI0_IRQHandler,           // 0x58: External Interrupt 0
    EXTI1_IRQHandler,           // 0x5C: External Interrupt 1
    // ... æ›´å¤šä¸­æ–· ...
};
```

---

## ðŸ”· ISRï¼ˆä¸­æ–·æœå‹™ç¨‹å¼ï¼‰æ’°å¯«åŽŸå‰‡

### âš ï¸ ISR æ‡‰è©²è¦ï¼š

```c
// 1. ç›¡å¯èƒ½çŸ­ä¸”å¿«é€Ÿ
void EXTI0_IRQHandler(void) {
    // æ¸…é™¤ä¸­æ–·æ——æ¨™
    EXTI->PR |= (1 << 0);
    
    // è¨­å®šæ——æ¨™ï¼Œè®“ä¸»ç¨‹å¼è™•ç†
    button_pressed = 1;
    
    // ä¸è¦åœ¨é€™è£¡åšè€—æ™‚æ“ä½œï¼
}

// 2. ä½¿ç”¨ volatile è®Šæ•¸å’Œä¸»ç¨‹å¼æºé€š
volatile int button_pressed = 0;

int main(void) {
    while (1) {
        if (button_pressed) {
            button_pressed = 0;
            handle_button();  // åœ¨ä¸»ç¨‹å¼åšè€—æ™‚è™•ç†
        }
    }
}
```

### âŒ ISR ä¸æ‡‰è©²ï¼š

```
1. åŸ·è¡Œè€—æ™‚æ“ä½œï¼ˆå¤§é‡é‹ç®—ã€ç­‰å¾…è¿´åœˆï¼‰
2. å‘¼å«éž reentrant å‡½å¼ï¼ˆå¦‚ printfã€mallocï¼‰
3. å­˜å–è¤‡é›œçš„è³‡æ–™çµæ§‹ï¼ˆæ²’æœ‰ä¿è­·çš„æƒ…æ³ä¸‹ï¼‰
4. åšå¤ªå¤šäº‹æƒ…
```

### ç‚ºä»€éº¼ ISR è¦çŸ­ï¼Ÿ

```
1. ISR åŸ·è¡Œæ™‚ï¼Œç›¸åŒæˆ–æ›´ä½Žå„ªå…ˆæ¬Šçš„ä¸­æ–·è¢«é˜»æ“‹
2. éŽé•·çš„ ISR æœƒå°Žè‡´ç³»çµ±åæ‡‰è®Šæ…¢
3. å¯èƒ½éŒ¯éŽå…¶ä»–é‡è¦äº‹ä»¶

æœ€ä½³å¯¦è¸ï¼šISR åªåšæœ€å¿…è¦çš„äº‹ï¼Œå…¶ä»–äº¤çµ¦ä¸»ç¨‹å¼
```

---

## ðŸ”· ä¸­æ–·å„ªå…ˆæ¬Šï¼ˆInterrupt Priorityï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸­æ–·å„ªå…ˆæ¬Šæ¦‚å¿µ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ•¸å­—è¶Šå°ï¼Œå„ªå…ˆæ¬Šè¶Šé«˜                                        â”‚
â”‚                                                             â”‚
â”‚  Priority 0: æœ€é«˜å„ªå…ˆæ¬Šï¼ˆé€šå¸¸æ˜¯ NMI æˆ–ç³»çµ±ä¾‹å¤–ï¼‰             â”‚
â”‚  Priority 1: è¼ƒé«˜                                           â”‚
â”‚  Priority 2: ä¸­ç­‰                                           â”‚
â”‚  Priority 3: è¼ƒä½Ž                                           â”‚
â”‚  ...                                                        â”‚
â”‚                                                             â”‚
â”‚  é«˜å„ªå…ˆæ¬Šä¸­æ–·å¯ä»¥æ‰“æ–·ä½Žå„ªå…ˆæ¬Šä¸­æ–·ï¼ˆNested Interruptï¼‰        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ARM Cortex-M çš„ NVIC

```c
// NVIC (Nested Vectored Interrupt Controller)

// è¨­å®šä¸­æ–·å„ªå…ˆæ¬Š
NVIC_SetPriority(EXTI0_IRQn, 2);

// å•Ÿç”¨ä¸­æ–·
NVIC_EnableIRQ(EXTI0_IRQn);

// ç¦ç”¨ä¸­æ–·
NVIC_DisableIRQ(EXTI0_IRQn);

// æ¸…é™¤ pending ä¸­æ–·
NVIC_ClearPendingIRQ(EXTI0_IRQn);
```

---

## ðŸ”· ä¸­æ–·å»¶é²ï¼ˆInterrupt Latencyï¼‰

```
ä¸­æ–·å»¶é² = å¾žä¸­æ–·ç™¼ç”Ÿåˆ° ISR é–‹å§‹åŸ·è¡Œçš„æ™‚é–“

çµ„æˆï¼š
1. ä¸­æ–·è­˜åˆ¥æ™‚é–“
2. å®Œæˆç•¶å‰æŒ‡ä»¤çš„æ™‚é–“
3. ä¿å­˜ Context çš„æ™‚é–“
4. å–å¾— ISR ä½å€çš„æ™‚é–“
5. è·³è½‰åˆ° ISR çš„æ™‚é–“

ARM Cortex-M3/M4 çš„ä¸­æ–·å»¶é²ç´„ 12 å€‹ clock cycles
ï¼ˆä¸å«ç­‰å¾…æ›´é«˜å„ªå…ˆæ¬Šä¸­æ–·çš„æ™‚é–“ï¼‰
```

---

## ðŸ”· è‡¨ç•Œå€æ®µï¼ˆCritical Sectionï¼‰

```c
// ç•¶å­˜å–å…±äº«è³‡æºæ™‚ï¼Œéœ€è¦æš«æ™‚ç¦ç”¨ä¸­æ–·

volatile int shared_counter = 0;

void increment_counter(void) {
    // é€²å…¥è‡¨ç•Œå€æ®µï¼šç¦ç”¨ä¸­æ–·
    __disable_irq();
    
    shared_counter++;  // å­˜å–å…±äº«è³‡æº
    
    // é›¢é–‹è‡¨ç•Œå€æ®µï¼šæ¢å¾©ä¸­æ–·
    __enable_irq();
}

// æ›´å¥½çš„æ–¹å¼ï¼šä¿å­˜ä¹‹å‰çš„ä¸­æ–·ç‹€æ…‹
void safe_increment(void) {
    uint32_t primask = __get_PRIMASK();  // ä¿å­˜ç›®å‰ç‹€æ…‹
    __disable_irq();
    
    shared_counter++;
    
    __set_PRIMASK(primask);  // æ¢å¾©ä¹‹å‰ç‹€æ…‹
}
```

---

## ðŸ“ å¸¸è¦‹é¢è©¦å•é¡Œ

**Q1ï¼šä»€éº¼æ˜¯ä¸­æ–·ï¼Ÿ**
```
ä¸­æ–·æ˜¯ä¸€ç¨®æ©Ÿåˆ¶ï¼Œè®“ CPU å¯ä»¥æš«åœç•¶å‰åŸ·è¡Œçš„ç¨‹å¼ï¼Œ
åŽ»è™•ç†æ›´ç·Šæ€¥çš„äº‹ä»¶ï¼ˆå¦‚ç¡¬é«”è¨Šè™Ÿï¼‰ï¼Œè™•ç†å®Œå¾Œå†è¿”å›žåŽŸç¨‹å¼ã€‚
é€™ä½¿ç³»çµ±èƒ½å³æ™‚éŸ¿æ‡‰å¤–éƒ¨äº‹ä»¶ï¼Œè€Œä¸éœ€è¦ä¸€ç›´è¼ªè©¢ï¼ˆpollingï¼‰ã€‚
```

**Q2ï¼šISR å’Œä¸€èˆ¬å‡½å¼æœ‰ä»€éº¼ä¸åŒï¼Ÿ**
```
1. ISR ç”±ç¡¬é«”è§¸ç™¼ï¼Œä¸€èˆ¬å‡½å¼ç”±ç¨‹å¼å‘¼å«
2. ISR åŸ·è¡Œå‰æœƒè‡ªå‹•ä¿å­˜ Context
3. ISR çµæŸæ™‚ä½¿ç”¨ç‰¹æ®Šçš„è¿”å›žæ©Ÿåˆ¶ï¼ˆä¸æ˜¯æ™®é€šçš„ returnï¼‰
4. ISR é€šå¸¸è¦æ¸…é™¤ä¸­æ–·æ——æ¨™
5. ISR æ‡‰è©²ç›¡å¯èƒ½çŸ­
6. ISR ä¸­ä½¿ç”¨çš„è®Šæ•¸éœ€è¦å®£å‘Šç‚º volatile
```

**Q3ï¼šä»€éº¼æ˜¯å·¢ç‹€ä¸­æ–·ï¼ˆNested Interruptï¼‰ï¼Ÿ**
```
åœ¨ ISR åŸ·è¡ŒéŽç¨‹ä¸­ï¼Œå…è¨±æ›´é«˜å„ªå…ˆæ¬Šçš„ä¸­æ–·æ‰“æ–·ã€‚

ä¾‹å¦‚ï¼š
- ISR A (å„ªå…ˆæ¬Š 3) æ­£åœ¨åŸ·è¡Œ
- ä¸­æ–· B (å„ªå…ˆæ¬Š 1) ç™¼ç”Ÿ
- ISR A è¢«æš«åœï¼Œé–‹å§‹åŸ·è¡Œ ISR B
- ISR B å®Œæˆå¾Œï¼Œè¿”å›ž ISR A
- ISR A å®Œæˆå¾Œï¼Œè¿”å›žä¸»ç¨‹å¼
```

**Q4ï¼šç‚ºä»€éº¼ ISR ä¸­ä½¿ç”¨çš„è®Šæ•¸è¦å®£å‘Š volatileï¼Ÿ**
```c
// éŒ¯èª¤ç¤ºç¯„ï¼š
int flag = 0;

void ISR(void) {
    flag = 1;
}

int main(void) {
    while (flag == 0) {
        // ç·¨è­¯å™¨å¯èƒ½å„ªåŒ–æˆç„¡é™è¿´åœˆï¼Œå› ç‚ºå®ƒèªç‚º flag ä¸æœƒæ”¹è®Š
    }
}

// æ­£ç¢ºç¤ºç¯„ï¼š
volatile int flag = 0;

void ISR(void) {
    flag = 1;
}

int main(void) {
    while (flag == 0) {
        // æ¯æ¬¡éƒ½æœƒçœŸæ­£è®€å– flag çš„å€¼
    }
}
```

**Q5ï¼šä¸­æ–·å’Œè¼ªè©¢ï¼ˆPollingï¼‰çš„æ¯”è¼ƒï¼Ÿ**
```
è¼ªè©¢ï¼ˆPollingï¼‰ï¼š
- CPU ä¸æ–·æª¢æŸ¥äº‹ä»¶æ˜¯å¦ç™¼ç”Ÿ
- æµªè²» CPU è³‡æº
- å»¶é²å–æ±ºæ–¼è¼ªè©¢é »çŽ‡
- å¯¦ä½œç°¡å–®

ä¸­æ–·ï¼ˆInterruptï¼‰ï¼š
- äº‹ä»¶ç™¼ç”Ÿæ™‚é€šçŸ¥ CPU
- CPU å¯ä»¥åšå…¶ä»–äº‹
- éŸ¿æ‡‰æ›´å³æ™‚
- å¯¦ä½œè¼ƒè¤‡é›œ

é©ç”¨å ´æ™¯ï¼š
- é«˜é »çŽ‡äº‹ä»¶ â†’ è¼ªè©¢å¯èƒ½æ›´å¥½ï¼ˆé¿å…é »ç¹ä¸­æ–·é–‹éŠ·ï¼‰
- ä½Žé »çŽ‡ã€éœ€å¿«é€ŸéŸ¿æ‡‰ â†’ ä¸­æ–·æ›´å¥½
```

---

## âœ… å¯¦ä½œç·´ç¿’

```
1. ç ”ç©¶ä½ ä½¿ç”¨çš„ MCUï¼ˆå¦‚ ARM Cortex-Mï¼‰çš„ä¸­æ–·æ©Ÿåˆ¶
2. é–±è®€ NVIC ç›¸é—œæš«å­˜å™¨
3. å¯«ä¸€å€‹ GPIO å¤–éƒ¨ä¸­æ–·ç¯„ä¾‹
4. å¯«ä¸€å€‹ Timer ä¸­æ–·ç¯„ä¾‹
5. ç·´ç¿’è¨­å®šä¸åŒçš„ä¸­æ–·å„ªå…ˆæ¬Š
```
