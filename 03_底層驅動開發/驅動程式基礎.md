# ğŸ”§ Linux é©…å‹•ç¨‹å¼åŸºç¤

> å¦‚æœä½ è¦é€²å…¥ IC å» åš BMC/åµŒå…¥å¼ Linuxï¼Œéœ€è¦äº†è§£ driver åŸºæœ¬æ¦‚å¿µ

---

## ğŸ“Œ ä»€éº¼æ˜¯é©…å‹•ç¨‹å¼ï¼ˆDriverï¼‰ï¼Ÿ

```
é©…å‹•ç¨‹å¼æ˜¯ã€Œè»Ÿé«”ã€å’Œã€Œç¡¬é«”ã€ä¹‹é–“çš„æ©‹æ¨‘ã€‚

æ‡‰ç”¨ç¨‹å¼
    â†“
ç³»çµ±å‘¼å«ï¼ˆopen, read, write, ioctlï¼‰
    â†“
Kernelï¼ˆæ ¸å¿ƒï¼‰
    â†“
é©…å‹•ç¨‹å¼ï¼ˆDriverï¼‰
    â†“
ç¡¬é«”

æ²’æœ‰ driverï¼Œä½œæ¥­ç³»çµ±ç„¡æ³•æ§åˆ¶ç¡¬é«”ã€‚
```

---

## ğŸ”· Linux Driver é¡å‹

### 1. Character Deviceï¼ˆå­—å…ƒè£ç½®ï¼‰

```
ç‰¹é»ï¼šè³‡æ–™ä»¥ã€Œbyte streamã€å‚³è¼¸ï¼Œå¯ä»¥é †åºå­˜å–
ç¯„ä¾‹ï¼šUARTã€éµç›¤ã€æ»‘é¼ ã€sensor

æ“ä½œï¼šopen, close, read, write, ioctl

è£ç½®æª”æ¡ˆï¼š/dev/ttyUSB0, /dev/input/mouse0
```

### 2. Block Deviceï¼ˆå€å¡Šè£ç½®ï¼‰

```
ç‰¹é»ï¼šè³‡æ–™ä»¥ã€Œblockã€ç‚ºå–®ä½å‚³è¼¸ï¼Œå¯ä»¥éš¨æ©Ÿå­˜å–
ç¯„ä¾‹ï¼šç¡¬ç¢Ÿã€SSDã€SDå¡ã€USB éš¨èº«ç¢Ÿ

æ“ä½œï¼šmount, seek, read, write

è£ç½®æª”æ¡ˆï¼š/dev/sda, /dev/mmcblk0
```

### 3. Network Deviceï¼ˆç¶²è·¯è£ç½®ï¼‰

```
ç‰¹é»ï¼šè™•ç†ç¶²è·¯å°åŒ…
ç¯„ä¾‹ï¼šEthernetã€WiFi

æ“ä½œï¼šsocket æ“ä½œ

è£ç½®æª”æ¡ˆï¼šä¸åœ¨ /dev ä¸‹ï¼Œç”¨ ifconfig/ip ç®¡ç†
```

---

## ğŸ”· Device Treeï¼ˆè£ç½®æ¨¹ï¼‰

### ä»€éº¼æ˜¯ Device Treeï¼Ÿ

```
Device Tree æ˜¯ä¸€ç¨®æè¿°ç¡¬é«”çµæ§‹çš„è³‡æ–™æ ¼å¼ã€‚

ç”¨é€”ï¼š
- å‘Šè¨´ kernelã€Œé€™å¡Šæ¿å­ä¸Šæœ‰å“ªäº›ç¡¬é«”ã€
- æä¾›ç¡¬é«”çš„ä½å€ã€ä¸­æ–·è™Ÿç¢¼ã€ç›¸å®¹æ€§è³‡è¨Š

å¥½è™•ï¼š
- åŒä¸€å€‹ kernel å¯ä»¥æ”¯æ´ä¸åŒçš„ç¡¬é«”æ¿
- ä¸éœ€è¦ç‚ºæ¯å¡Šæ¿å­é‡æ–°ç·¨è­¯ kernel
```

### Device Tree èªæ³•ç¯„ä¾‹

```dts
// æª”æ¡ˆï¼šxxx-board.dts

/dts-v1/;

/ {
    compatible = "vendor,board-name";
    
    // I2C æ§åˆ¶å™¨
    i2c@40005400 {
        compatible = "vendor,i2c-controller";
        reg = <0x40005400 0x100>;  // åŸºåº•ä½å€å’Œå¤§å°
        interrupts = <31>;          // ä¸­æ–·è™Ÿç¢¼
        #address-cells = <1>;
        #size-cells = <0>;
        
        // æ›åœ¨ I2C ä¸Šçš„ sensor
        temp_sensor@48 {
            compatible = "ti,tmp102";
            reg = <0x48>;  // I2C åœ°å€
        };
    };
    
    // GPIO æ§åˆ¶å™¨
    gpio@40010000 {
        compatible = "vendor,gpio";
        reg = <0x40010000 0x400>;
        gpio-controller;
        #gpio-cells = <2>;
    };
};
```

### å¸¸ç”¨ Device Tree å±¬æ€§

| å±¬æ€§ | èªªæ˜ |
|-----|------|
| `compatible` | ç”¨ä¾†åŒ¹é… driver |
| `reg` | æš«å­˜å™¨ä½å€å’Œå¤§å° |
| `interrupts` | ä¸­æ–·è™Ÿç¢¼ |
| `status` | "okay" æˆ– "disabled" |
| `clocks` | æ™‚è„ˆä¾†æº |
| `#address-cells` | åœ°å€ç”¨å¹¾å€‹ cell è¡¨ç¤º |
| `#size-cells` | å¤§å°ç”¨å¹¾å€‹ cell è¡¨ç¤º |

---

## ğŸ”· ç°¡å–®çš„ Character Driver ç¯„ä¾‹

```c
// simple_driver.c

#include <linux/module.h>
#include <linux/fs.h>
#include <linux/cdev.h>
#include <linux/uaccess.h>

#define DEVICE_NAME "simple_dev"
#define BUFFER_SIZE 256

static dev_t dev_num;
static struct cdev my_cdev;
static struct class *my_class;
static char device_buffer[BUFFER_SIZE];

// ç•¶ä½¿ç”¨è€… open(/dev/simple_dev) æ™‚å‘¼å«
static int my_open(struct inode *inode, struct file *file) {
    pr_info("Device opened\n");
    return 0;
}

// ç•¶ä½¿ç”¨è€… close æ™‚å‘¼å«
static int my_release(struct inode *inode, struct file *file) {
    pr_info("Device closed\n");
    return 0;
}

// ç•¶ä½¿ç”¨è€… read æ™‚å‘¼å«
static ssize_t my_read(struct file *file, char __user *buf, 
                       size_t count, loff_t *offset) {
    size_t bytes_to_read = min(count, (size_t)(BUFFER_SIZE - *offset));
    
    if (*offset >= BUFFER_SIZE)
        return 0;
    
    // å¾ kernel ç©ºé–“è¤‡è£½åˆ° user ç©ºé–“
    if (copy_to_user(buf, device_buffer + *offset, bytes_to_read))
        return -EFAULT;
    
    *offset += bytes_to_read;
    return bytes_to_read;
}

// ç•¶ä½¿ç”¨è€… write æ™‚å‘¼å«
static ssize_t my_write(struct file *file, const char __user *buf,
                        size_t count, loff_t *offset) {
    size_t bytes_to_write = min(count, (size_t)BUFFER_SIZE);
    
    // å¾ user ç©ºé–“è¤‡è£½åˆ° kernel ç©ºé–“
    if (copy_from_user(device_buffer, buf, bytes_to_write))
        return -EFAULT;
    
    return bytes_to_write;
}

// file_operations çµæ§‹é«”ï¼šé€£æ¥ç³»çµ±å‘¼å«å’Œ driver å‡½å¼
static struct file_operations fops = {
    .owner = THIS_MODULE,
    .open = my_open,
    .release = my_release,
    .read = my_read,
    .write = my_write,
};

// è¼‰å…¥ module æ™‚å‘¼å«
static int __init my_init(void) {
    // 1. åˆ†é…è£ç½®è™Ÿç¢¼
    alloc_chrdev_region(&dev_num, 0, 1, DEVICE_NAME);
    
    // 2. åˆå§‹åŒ– cdev
    cdev_init(&my_cdev, &fops);
    cdev_add(&my_cdev, dev_num, 1);
    
    // 3. å»ºç«‹ /dev/simple_dev
    my_class = class_create(THIS_MODULE, DEVICE_NAME);
    device_create(my_class, NULL, dev_num, NULL, DEVICE_NAME);
    
    pr_info("Driver loaded: major=%d, minor=%d\n", 
            MAJOR(dev_num), MINOR(dev_num));
    return 0;
}

// å¸è¼‰ module æ™‚å‘¼å«
static void __exit my_exit(void) {
    device_destroy(my_class, dev_num);
    class_destroy(my_class);
    cdev_del(&my_cdev);
    unregister_chrdev_region(dev_num, 1);
    pr_info("Driver unloaded\n");
}

module_init(my_init);
module_exit(my_exit);
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Your Name");
MODULE_DESCRIPTION("Simple Character Driver");
```

### ç·¨è­¯å’Œä½¿ç”¨

```bash
# Makefile
obj-m += simple_driver.o

# ç·¨è­¯
make -C /lib/modules/$(uname -r)/build M=$(pwd) modules

# è¼‰å…¥ module
sudo insmod simple_driver.ko

# æŸ¥çœ‹ /dev
ls -l /dev/simple_dev

# æ¸¬è©¦å¯«å…¥
echo "Hello" | sudo tee /dev/simple_dev

# æ¸¬è©¦è®€å–
sudo cat /dev/simple_dev

# å¸è¼‰ module
sudo rmmod simple_driver
```

---

## ğŸ”· é‡è¦æ¦‚å¿µï¼šUser Space vs Kernel Space

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User Space                           â”‚
â”‚                                                             â”‚
â”‚   æ‡‰ç”¨ç¨‹å¼ï¼ˆ/bin/appï¼‰                                       â”‚
â”‚       â†“ ç³»çµ±å‘¼å«ï¼ˆsyscallï¼‰                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       Kernel Space                          â”‚
â”‚                                                             â”‚
â”‚   VFS (Virtual File System)                                 â”‚
â”‚       â†“                                                     â”‚
â”‚   é©…å‹•ç¨‹å¼                                                   â”‚
â”‚       â†“                                                     â”‚
â”‚   ç¡¬é«”æŠ½è±¡å±¤                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Hardware                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é‡è¦å‡½å¼

| å‡½å¼ | ç”¨é€” |
|-----|------|
| `copy_to_user()` | Kernel â†’ Userï¼Œç”¨æ–¼ read |
| `copy_from_user()` | User â†’ Kernelï¼Œç”¨æ–¼ write |

**ç‚ºä»€éº¼éœ€è¦é€™äº›å‡½å¼ï¼Ÿ**
```
User space å’Œ Kernel space ä½¿ç”¨ä¸åŒçš„è¨˜æ†¶é«”ç©ºé–“ã€‚
ç›´æ¥å­˜å–å°æ–¹çš„è¨˜æ†¶é«”æ˜¯éæ³•ä¸”å±éšªçš„ã€‚
é€™äº›å‡½å¼æœƒæª¢æŸ¥ä½å€åˆæ³•æ€§ä¸¦å®‰å…¨åœ°è¤‡è£½è³‡æ–™ã€‚
```

---

## ğŸ“ å¸¸è¦‹é¢è©¦å•é¡Œ

**Q1ï¼šä»€éº¼æ˜¯ Driverï¼Ÿ**
```
Driver æ˜¯ä½œæ¥­ç³»çµ±ä¸­ç”¨ä¾†æ§åˆ¶ç¡¬é«”çš„è»Ÿé«”æ¨¡çµ„ã€‚
å®ƒæä¾›æ¨™æº–åŒ–çš„ä»‹é¢ï¼ˆå¦‚ open/read/writeï¼‰çµ¦ä¸Šå±¤æ‡‰ç”¨ç¨‹å¼ï¼Œ
ä¸¦å°‡é€™äº›æ“ä½œè½‰æ›æˆç¡¬é«”å¯ä»¥ç†è§£çš„æŒ‡ä»¤ã€‚
```

**Q2ï¼šCharacter Device å’Œ Block Device çš„å·®ç•°ï¼Ÿ**
```
Character Deviceï¼š
- ä»¥ byte stream å‚³è¼¸
- é †åºå­˜å–
- ä¾‹å¦‚ï¼šUARTã€éµç›¤

Block Deviceï¼š
- ä»¥å›ºå®šå¤§å°çš„ block å‚³è¼¸
- æ”¯æ´éš¨æ©Ÿå­˜å–
- æœ‰ buffer cache
- ä¾‹å¦‚ï¼šç¡¬ç¢Ÿã€SSD
```

**Q3ï¼šä»€éº¼æ˜¯ major number å’Œ minor numberï¼Ÿ**
```
Major numberï¼šè­˜åˆ¥é©…å‹•ç¨‹å¼ï¼ˆå“ªä¸€å€‹ driverï¼‰
Minor numberï¼šè­˜åˆ¥å…·é«”çš„è£ç½®ï¼ˆåŒé¡è£ç½®ä¸­çš„å“ªä¸€å€‹ï¼‰

ä¾‹å¦‚ï¼š
/dev/ttyS0 â†’ major=4, minor=64
/dev/ttyS1 â†’ major=4, minor=65
ï¼ˆåŒä¸€å€‹ serial driverï¼Œä¸åŒçš„ UART åŸ ï¼‰
```

**Q4ï¼šioctl æ˜¯ä»€éº¼ï¼Ÿ**
```
ioctl (I/O Control) æ˜¯ä¸€ç¨®ç³»çµ±å‘¼å«ï¼Œç”¨ä¾†ï¼š
- è¨­å®šè£ç½®åƒæ•¸
- å–å¾—è£ç½®ç‹€æ…‹
- åŸ·è¡Œ read/write ç„¡æ³•å®Œæˆçš„æ“ä½œ

ç¯„ä¾‹ï¼šè¨­å®š UART baud rateã€å–å¾— sensor æ ¡æ­£åƒæ•¸
```

**Q5ï¼šä»€éº¼æ˜¯ Device Treeï¼Ÿç‚ºä»€éº¼éœ€è¦å®ƒï¼Ÿ**
```
Device Tree æ˜¯æè¿°ç¡¬é«”çµæ§‹çš„è³‡æ–™çµæ§‹ã€‚

æ²’æœ‰ Device Tree æ™‚ï¼š
- ç¡¬é«”è³‡è¨Šå¯«æ­»åœ¨ kernel åŸå§‹ç¢¼
- æ¯æ›ä¸€å¡Šæ¿å­è¦é‡æ–°ç·¨è­¯ kernel

æœ‰ Device Tree å¾Œï¼š
- ç¡¬é«”è³‡è¨Šç¨ç«‹åœ¨ .dts æª”æ¡ˆ
- åŒä¸€å€‹ kernel é…åˆä¸åŒ .dtb æ”¯æ´ä¸åŒæ¿å­
```

---

## âœ… å»ºè­°å­¸ç¿’é †åº

```
1. å…ˆç†è§£ Linux çš„ User Space / Kernel Space æ¦‚å¿µ
2. å­¸ç¿’ module çš„è¼‰å…¥å’Œå¸è¼‰ï¼ˆinsmod/rmmodï¼‰
3. é–±è®€ç°¡å–®çš„ Character Driver ç¯„ä¾‹
4. ç†è§£ file_operations çµæ§‹é«”
5. å­¸ç¿’ Device Tree åŸºæœ¬èªæ³•
6. ï¼ˆé€²éšï¼‰å­¸ç¿’ Platform Driver å’Œ Device Model
```

---

## ğŸ“š å»¶ä¼¸é–±è®€

- Linux Device Drivers, 3rd Edition (LDD3) - å…è²»ç·šä¸Šç‰ˆ
- Bootlin (åŸ Free Electrons) çš„ Training Materials
- ã€ŠLinux Kernel Developmentã€‹by Robert Love
