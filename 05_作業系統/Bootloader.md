# ğŸš€ Bootloader èˆ‡é–‹æ©Ÿæµç¨‹å®Œæ•´æŒ‡å—

> **å­¸ç¿’ç›®æ¨™**
> 1. æ·±å…¥ç†è§£ ARM vs x86 é–‹æ©Ÿæµç¨‹å·®ç•°
> 2. æŒæ¡ ATF (ARM Trusted Firmware) æ¶æ§‹
> 3. ç†è§£ Secure Boot èˆ‡ Chain of Trust
> 4. ç†Ÿç·´ U-Boot æ“ä½œèˆ‡é©…å‹•æ¨¡å‹ (DM)
> 5. æŒæ¡ Device Tree èˆ‡ FIT Image

---

## ğŸ“Œ ç¬¬ä¸€éƒ¨åˆ†ï¼šBootloader åŸºç¤

### 1.1 ä»€éº¼æ˜¯ Bootloaderï¼Ÿ

```
Bootloader = ç³»çµ±å•Ÿå‹•æ™‚ç¬¬ä¸€å€‹åŸ·è¡Œçš„è»Ÿé«”

å·¥ä½œå…§å®¹ï¼š
1. åˆå§‹åŒ–ç¡¬é«”ï¼ˆCPUã€è¨˜æ†¶é«”ã€æ™‚è„ˆï¼‰
2. è¼‰å…¥ä½œæ¥­ç³»çµ±
3. æŠŠæ§åˆ¶æ¬Šäº¤çµ¦ OS

é¡æ¯”ï¼š
é›»è…¦é–‹æ©Ÿ â†’ BIOS/UEFI â†’ GRUB/U-Boot â†’ Linux Kernel
```

### 1.2 ç‚ºä»€éº¼éœ€è¦å¤šéšæ®µ Bootloaderï¼Ÿ

```
ç³»çµ±å‰›ä¸Šé›»æ™‚è³‡æºéå¸¸æœ‰é™ï¼š
- DRAM é‚„æ²’åˆå§‹åŒ–ï¼Œåªæœ‰ SRAM (å¹¾å KB)
- Boot ROM ç©ºé–“å¾ˆå°ï¼ˆæ™¶ç‰‡å…§å»ºï¼‰

æ‰€ä»¥åˆ†éšæ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 0    â”‚ Boot ROM (æ™¶ç‰‡å…§å»ºï¼Œä¸å¯ä¿®æ”¹)                     â”‚
â”‚ Stage 1    â”‚ SPL (åœ¨ SRAM åŸ·è¡Œï¼Œåˆå§‹åŒ– DRAM)                   â”‚
â”‚ Stage 2    â”‚ U-Boot (åœ¨ DRAM åŸ·è¡Œï¼Œå®Œæ•´åŠŸèƒ½)                   â”‚
â”‚ Stage 3    â”‚ Linux Kernel                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”· ç¬¬äºŒéƒ¨åˆ†ï¼šARM vs x86 é–‹æ©Ÿæµç¨‹

### 2.1 ARM é–‹æ©Ÿæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ARM (å¦‚ AST2600 BMC)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Power On                                                    â”‚
â”‚      â†“                                                       â”‚
â”‚  Boot ROM (å…§å»ºæ–¼ SoC)                                       â”‚
â”‚      â†“ è¼‰å…¥ SPL                                              â”‚
â”‚  SPL (Secondary Program Loader)                              â”‚
â”‚      â†“ åˆå§‹åŒ– DRAMï¼Œè¼‰å…¥ U-Boot                               â”‚
â”‚  U-Boot                                                      â”‚
â”‚      â†“ è¼‰å…¥ kernel + DTB                                     â”‚
â”‚  Linux Kernel                                                â”‚
â”‚      â†“                                                       â”‚
â”‚  Root Filesystem                                             â”‚
â”‚                                                              â”‚
â”‚  è¨˜æ†¶é«”æ¼”é€²ï¼š                                                  â”‚
â”‚  Boot ROM: SRAM only                                         â”‚
â”‚  SPL: SRAM â†’ åˆå§‹åŒ– DRAM                                     â”‚
â”‚  U-Boot: å®Œæ•´ DRAM å¯ç”¨                                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 x86 é–‹æ©Ÿæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   x86 ä¼ºæœå™¨ (UEFI)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Power On                                                    â”‚
â”‚      â†“                                                       â”‚
â”‚  Reset Vector (CPU å¾ 0xFFFFFFF0 é–‹å§‹)                       â”‚
â”‚      â†“                                                       â”‚
â”‚  UEFI Firmware (SEC â†’ PEI â†’ DXE â†’ BDS)                       â”‚
â”‚      â†“                                                       â”‚
â”‚  UEFI Boot Manager                                           â”‚
â”‚      â†“ é¸æ“‡ Boot Entry                                       â”‚
â”‚  Bootloader (GRUB / systemd-boot)                            â”‚
â”‚      â†“ è¼‰å…¥ kernel                                           â”‚
â”‚  Linux Kernel                                                â”‚
â”‚      â†“                                                       â”‚
â”‚  Initramfs â†’ Root Filesystem                                 â”‚
â”‚                                                              â”‚
â”‚  UEFI éšæ®µï¼š                                                  â”‚
â”‚  SEC: Security Phase (æœ€æ—©æœŸåˆå§‹åŒ–)                           â”‚
â”‚  PEI: Pre-EFI Initialization (è¨˜æ†¶é«”åˆå§‹åŒ–)                   â”‚
â”‚  DXE: Driver Execution Environment                           â”‚
â”‚  BDS: Boot Device Selection                                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 ä¸»è¦å·®ç•°

| ç‰¹æ€§ | ARM | x86 |
|:---|:---|:---|
| Reset Vector | 0x0 æˆ–é«˜ä½å€ | 0xFFFFFFF0 |
| æ¨™æº– Firmware | U-Boot | UEFI |
| Device Tree | å¿…é ˆ | é€šå¸¸ ACPI |
| Boot Device | SPI Flash, eMMC | SPI Flash, NVMe |
| é–‹æ©Ÿä»‹é¢ | UART console | VGA/Serial |

---

## ğŸ”· ç¬¬ä¸‰éƒ¨åˆ†ï¼šARM Trusted Firmware (ATF)

### 3.1 ATF æ¦‚è¿°

```
ATF (ç¾ç¨± TF-A = Trusted Firmware-A) æ˜¯ ARM å®˜æ–¹çš„åƒè€ƒå¯¦ä½œï¼Œ
æä¾›å®‰å…¨å•Ÿå‹•å’ŒåŸ·è¡Œæ™‚æœå‹™ã€‚

ç‚ºä»€éº¼éœ€è¦ ATFï¼Ÿ
- å¯¦ç¾ ARM çš„ Security Extensions
- ç®¡ç† Exception Levels (EL0-EL3)
- æä¾› Secure Boot æ¡†æ¶
- Power Management æœå‹™
```

### 3.2 ARM Exception Levels

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ARM Exception Levels                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  EL3 (Secure Monitor)    â† ATF BL31                         â”‚
â”‚    â”‚  - æœ€é«˜æ¬Šé™                                             â”‚
â”‚    â”‚  - è™•ç† Secure/Non-Secure åˆ‡æ›                          â”‚
â”‚    â†“                                                         â”‚
â”‚  EL2 (Hypervisor)        â† KVM / è™›æ“¬åŒ–                      â”‚
â”‚    â”‚  - å¯é¸                                                 â”‚
â”‚    â†“                                                         â”‚
â”‚  EL1 (Kernel)            â† Linux Kernel / RTOS              â”‚
â”‚    â”‚                                                         â”‚
â”‚    â†“                                                         â”‚
â”‚  EL0 (User)              â† User Applications                â”‚
â”‚                                                              â”‚
â”‚  Secure World        â”‚    Normal World                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  Secure OS (OP-TEE)  â”‚    Linux                             â”‚
â”‚  Trusted Apps        â”‚    Normal Apps                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ATF å•Ÿå‹•éšæ®µ

```
ATF å°‡å•Ÿå‹•åˆ†ç‚ºå¤šå€‹ BL (Boot Loader) éšæ®µï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL1    â”‚ åœ¨ ROM æˆ– Flash åŸ·è¡Œï¼Œè¼‰å…¥ BL2                      â”‚
â”‚        â”‚ é©—è­‰ BL2 ç°½ç« ï¼ˆå¦‚æœ‰ Secure Bootï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BL2    â”‚ åœ¨ SRAM åŸ·è¡Œï¼Œåˆå§‹åŒ– DRAM                          â”‚
â”‚        â”‚ è¼‰å…¥ BL31, BL32, BL33                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BL31   â”‚ EL3 Runtime Serviceï¼Œå¸¸é§åœ¨è¨˜æ†¶é«”                   â”‚
â”‚        â”‚ è™•ç† SMC (Secure Monitor Call)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BL32   â”‚ Secure OS (å¦‚ OP-TEE)ï¼Œå¯é¸                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BL33   â”‚ Normal World Bootloader (U-Boot æˆ– UEFI)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”· ç¬¬å››éƒ¨åˆ†ï¼šSecure Boot

### 4.1 Chain of Trust

```
Secure Boot å»ºç«‹ã€Œä¿¡ä»»éˆã€ï¼šæ¯ä¸€éšæ®µé©—è­‰ä¸‹ä¸€éšæ®µ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Chain of Trust                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Root of Trust (ç¡¬é«”)                                        â”‚
â”‚      â”‚  - æ™¶ç‰‡å…§å»ºçš„å…¬é‘° (OTP)                                â”‚
â”‚      â”‚  - ä¸å¯ä¿®æ”¹                                           â”‚
â”‚      â†“  é©—è­‰                                                 â”‚
â”‚  Boot ROM                                                    â”‚
â”‚      â”‚                                                       â”‚
â”‚      â†“  é©—è­‰ç°½ç«                                              â”‚
â”‚  ATF BL1                                                     â”‚
â”‚      â”‚                                                       â”‚
â”‚      â†“  é©—è­‰ç°½ç«                                              â”‚
â”‚  ATF BL2 / SPL                                               â”‚
â”‚      â”‚                                                       â”‚
â”‚      â†“  é©—è­‰ç°½ç«                                              â”‚
â”‚  U-Boot                                                      â”‚
â”‚      â”‚                                                       â”‚
â”‚      â†“  é©—è­‰ç°½ç«  (FIT Image)                                 â”‚
â”‚  Linux Kernel + DTB + initramfs                              â”‚
â”‚                                                              â”‚
â”‚  å¦‚æœä»»ä½•ä¸€å€‹ç’°ç¯€é©—è­‰å¤±æ•— â†’ åœæ­¢é–‹æ©Ÿ                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç°½ç« é©—è­‰æ©Ÿåˆ¶

```c
/* ç°½ç« é©—è­‰æµç¨‹ (ç°¡åŒ–) */

/* 1. è¨ˆç®— Image Hash */
SHA256(image_data, image_size, hash);

/* 2. ç”¨å…¬é‘°é©—è­‰ç°½ç«  */
int verified = RSA_verify(public_key, signature, hash);

/* 3. é©—è­‰æˆåŠŸæ‰è¼‰å…¥åŸ·è¡Œ */
if (verified)
    boot_next_stage();
else
    panic("Signature verification failed!");

/* U-Boot ä¸­çš„é©—è­‰ */
/* ä½¿ç”¨ FIT Image çš„ signature ç¯€é» */
```

### 4.3 OpenBMC Secure Boot

```
OpenBMC åœ¨ AST2600 ä¸Šçš„ Secure Bootï¼š

1. AST2600 Boot ROM é©—è­‰ SPL
2. SPL é©—è­‰ U-Boot
3. U-Boot é©—è­‰ FIT Image (kernel + DTB + rootfs)
4. ä½¿ç”¨ verified-boot æ©Ÿåˆ¶

å•Ÿç”¨æ–¹å¼ï¼š
- ç‡’éŒ„å…¬é‘°åˆ° OTP (One-Time Programmable)
- ç°½ç½²æ‰€æœ‰ boot images
- è¨­å®š security strap
```

---

## ğŸ”· ç¬¬äº”éƒ¨åˆ†ï¼šU-Boot è©³è§£

### 5.1 å¸¸ç”¨å‘½ä»¤

```bash
# ç’°å¢ƒè®Šæ•¸
printenv              # é¡¯ç¤ºæ‰€æœ‰ç’°å¢ƒè®Šæ•¸
setenv foo bar        # è¨­å®šç’°å¢ƒè®Šæ•¸
saveenv               # å„²å­˜åˆ° Flash

# è¨˜æ†¶é«”æ“ä½œ
md 0x80000000 100     # é¡¯ç¤ºè¨˜æ†¶é«” (memory display)
mw 0x80000000 0xDEAD  # å¯«å…¥è¨˜æ†¶é«” (memory write)
cp 0x80000000 0x81000000 0x1000  # è¤‡è£½è¨˜æ†¶é«”

# Flash æ“ä½œ
sf probe              # åˆå§‹åŒ– SPI Flash
sf read 0x80000000 0x100000 0x500000   # è®€å–
sf erase 0x100000 0x10000              # æ“¦é™¤
sf write 0x80000000 0x100000 0x10000   # å¯«å…¥

# eMMC/SD
mmc dev 0             # é¸æ“‡ mmc device
mmc read 0x80000000 0x800 0x1000  # è®€å–

# ç¶²è·¯
setenv ipaddr 192.168.1.10
setenv serverip 192.168.1.100
tftp 0x80000000 uImage   # å¾ TFTP ä¸‹è¼‰
ping 192.168.1.1

# é–‹æ©Ÿ
bootm 0x80000000      # å•Ÿå‹• uImage
bootz 0x80000000 - 0x81000000  # å•Ÿå‹• zImage + DTB
```

### 5.2 U-Boot Driver Model (DM)

```c
/* U-Boot DM æ˜¯é¡ä¼¼ Linux Kernel çš„é©…å‹•æ¡†æ¶ */

/* å®šç¾©ä¸€å€‹ UCLASS (é©…å‹•é¡å‹) */
UCLASS_DRIVER(gpio) = {
    .id = UCLASS_GPIO,
    .name = "gpio",
    .per_device_auto = sizeof(struct gpio_dev_priv),
};

/* å®šç¾©ä¸€å€‹å…·é«” Driver */
static const struct dm_gpio_ops my_gpio_ops = {
    .direction_input = my_gpio_direction_input,
    .direction_output = my_gpio_direction_output,
    .get_value = my_gpio_get_value,
    .set_value = my_gpio_set_value,
};

U_BOOT_DRIVER(my_gpio) = {
    .name = "my-gpio",
    .id = UCLASS_GPIO,
    .of_match = my_gpio_ids,
    .ops = &my_gpio_ops,
    .probe = my_gpio_probe,
    .priv_auto = sizeof(struct my_gpio_priv),
};
```

---

## ğŸ”· ç¬¬å…­éƒ¨åˆ†ï¼šDevice Tree èˆ‡ FIT Image

### 6.1 Device Tree Blob (DTB)

```c
/* Device Tree å‘Šè¨´ Kernel ç¡¬é«”é…ç½® */

/* DTS åŸå§‹ç¢¼ç¯„ä¾‹ */
/dts-v1/;

/ {
    compatible = "aspeed,ast2600";
    
    cpus {
        cpu@0 {
            compatible = "arm,cortex-a7";
        };
    };
    
    memory@80000000 {
        device_type = "memory";
        reg = <0x80000000 0x40000000>;  /* 1GB */
    };
    
    i2c0: i2c@1e78a000 {
        compatible = "aspeed,ast2600-i2c";
        reg = <0x1e78a000 0x80>;
        interrupts = <GIC_SPI 110 IRQ_TYPE_LEVEL_HIGH>;
        #address-cells = <1>;
        #size-cells = <0>;
        
        temp_sensor@48 {
            compatible = "ti,tmp102";
            reg = <0x48>;
        };
    };
};
```

### 6.2 FIT Image

```c
/* FIT (Flattened Image Tree) æ‰“åŒ…å¤šå€‹ image */

/* FIT Image çµæ§‹ (.its æª”) */
/dts-v1/;

/ {
    description = "OpenBMC FIT Image";
    
    images {
        kernel {
            data = /incbin/("zImage");
            type = "kernel";
            arch = "arm";
            compression = "none";
            hash-1 { algo = "sha256"; };
        };
        
        fdt {
            data = /incbin/("board.dtb");
            type = "flat_dt";
            arch = "arm";
            compression = "none";
            hash-1 { algo = "sha256"; };
        };
        
        ramdisk {
            data = /incbin/("rootfs.cpio.gz");
            type = "ramdisk";
            arch = "arm";
            compression = "gzip";
            hash-1 { algo = "sha256"; };
        };
    };
    
    configurations {
        default = "conf";
        conf {
            kernel = "kernel";
            fdt = "fdt";
            ramdisk = "ramdisk";
            signature {
                algo = "sha256,rsa2048";
                key-name-hint = "dev-key";
                sign-images = "kernel", "fdt", "ramdisk";
            };
        };
    };
};
```

### 6.3 è£½ä½œ FIT Image

```bash
# ç·¨è­¯ DTS æˆ DTB
dtc -I dts -O dtb board.dts -o board.dtb

# è£½ä½œ FIT Image
mkimage -f image.its image.fit

# ç°½ç½² FIT Image (Secure Boot)
mkimage -F -k /path/to/keys -r image.fit
```

---

## ğŸ“ é¢è©¦é¡Œåº«

### Q1: ARM å’Œ x86 é–‹æ©Ÿæµç¨‹çš„ä¸»è¦å·®ç•°ï¼Ÿ

**é›£åº¦**ï¼šâ­â­â­â­

**ç­”æ¡ˆ**ï¼š
| ç‰¹æ€§ | ARM | x86 |
|:---|:---|:---|
| Reset Vector | 0x0 (ä½ä½å€) | 0xFFFFFFF0 (é«˜ä½å€) |
| Firmware | U-Boot | UEFI |
| ç¡¬é«”æè¿° | Device Tree | ACPI |
| è¨˜æ†¶é«”æ˜ å°„ | ç”± SoC å®šç¾© | è¼ƒçµ±ä¸€ |

### Q2: ä»€éº¼æ˜¯ ATFï¼ŸBL31 çš„ä½œç”¨ï¼Ÿ

**é›£åº¦**ï¼šâ­â­â­â­â­
**å¸¸è¦‹æ–¼**ï¼šNVIDIA / ARM è·ä½

**ç­”æ¡ˆ**ï¼š
ATF (TF-A) æ˜¯ ARM çš„å®‰å…¨å•Ÿå‹•åƒè€ƒå¯¦ä½œã€‚

BL31 (EL3 Runtime)ï¼š
- å¸¸é§è¨˜æ†¶é«”
- è™•ç† SMC (Secure Monitor Call)
- ç®¡ç† Secure/Normal World åˆ‡æ›
- æä¾› PSCI (Power State Coordination Interface)

### Q3: Secure Boot çš„ Chain of Trust å¦‚ä½•é‹ä½œï¼Ÿ

**é›£åº¦**ï¼šâ­â­â­â­â­

**ç­”æ¡ˆ**ï¼š
1. Root of Trustï¼šæ™¶ç‰‡å…§å»ºä¸å¯ä¿®æ”¹çš„å…¬é‘° (OTP)
2. Boot ROM ä½¿ç”¨æ­¤å…¬é‘°é©—è­‰ä¸‹ä¸€éšæ®µ
3. æ¯å€‹éšæ®µé©—è­‰ä¸‹ä¸€éšæ®µçš„ç°½ç« 
4. ä»»ä½•é©—è­‰å¤±æ•—éƒ½æœƒåœæ­¢é–‹æ©Ÿ

é—œéµï¼šä¿¡ä»»å¾ç¡¬é«”é–‹å§‹ï¼Œé€å±¤å‘ä¸Šå»ºç«‹ã€‚

### Q4: ä»€éº¼æ˜¯ FIT Imageï¼Ÿå„ªé»æ˜¯ä»€éº¼ï¼Ÿ

**é›£åº¦**ï¼šâ­â­â­â­

**ç­”æ¡ˆ**ï¼š
FIT (Flattened Image Tree) æ˜¯ U-Boot æ”¯æ´çš„æ˜ åƒæ ¼å¼ã€‚

å„ªé»ï¼š
1. æ‰“åŒ…å¤šå€‹ image (kernel, DTB, initramfs)
2. æ”¯æ´æ•¸ä½ç°½ç« é©—è­‰
3. æ”¯æ´å¤šç¨®å£“ç¸®
4. é…ç½®éˆæ´»ï¼ˆå¤šå€‹ configurationï¼‰
5. å–®ä¸€æª”æ¡ˆæ˜“æ–¼ç®¡ç†

### Q5: è§£é‡‹ U-Boot çš„ bootcmd ç’°å¢ƒè®Šæ•¸

**é›£åº¦**ï¼šâ­â­â­

**ç­”æ¡ˆ**ï¼š
```bash
# bootcmd æ˜¯é–‹æ©Ÿæ™‚è‡ªå‹•åŸ·è¡Œçš„å‘½ä»¤
bootcmd=sf probe; sf read 0x80000000 0x100000 0x500000; bootm 0x80000000

# è§£é‡‹ï¼š
# sf probe - åˆå§‹åŒ– SPI Flash
# sf read - å¾ Flash è®€å– kernel åˆ° RAM
# bootm - å•Ÿå‹• kernel
```

---

## âœ… ç« ç¯€å®Œæˆå ±å‘Š

- æª”æ¡ˆï¼š`/05_ä½œæ¥­ç³»çµ±/Bootloader.md`
- æ“´å……å‰è¡Œæ•¸ï¼š318 è¡Œ
- æ“´å……å¾Œè¡Œæ•¸ï¼šç´„ 500 è¡Œ
- æ¶µè“‹ï¼šARM vs x86 Boot æµç¨‹ã€ATF/TF-Aã€Exception Levelsã€Secure Boot Chain of Trustã€U-Boot DMã€FIT Image
